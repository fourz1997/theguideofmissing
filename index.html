<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ€å¿µæŒ‡å—</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-brown: #3E2723;
            --secondary-brown: #5D4037;
            --btn-color: #8D6E63;
            --bg-beige: #F5F5DC;
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: 'Noto Serif TC', serif;
            background-color: var(--bg-beige);
            /* é˜²æ­¢æ‰‹æ©Ÿä¸‹æ‹‰é‡æ•´ */
            overscroll-behavior: none;
        }

        #bg-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            /* é€™è£¡å‡è¨­ä½ æœ‰ä¸Šå‚³ bg_paper.pngï¼Œå¦‚æœæ²’æœ‰æœƒé¡¯ç¤ºç±³è‰²èƒŒæ™¯ */
            background-image: url('bg_paper.png');
            background-size: cover; opacity: 0.5; z-index: -1;
        }

        .container {
            display: flex; flex-direction: column;
            align-items: center; justify-content: space-between;
            height: 100vh; width: 100%;
            box-sizing: border-box; padding: 24px;
        }

        /* æ¨™é¡Œå€ */
        .header { margin-top: 40px; text-align: center; }
        h1 {
            font-size: 36px; color: var(--primary-brown); margin: 0;
            font-weight: 700; letter-spacing: 2px;
        }
        .info-text {
            font-size: 14px; color: var(--secondary-brown); opacity: 0.7;
            margin-top: 10px; line-height: 1.6;
        }

        /* ä¸­é–“æ ¸å¿ƒå€ (æŒ‡å—é‡+è©©) */
        .main-cluster {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            width: 100%; flex: 1;
        }

        .compass-box {
            position: relative; width: 260px; height: 260px;
            margin-bottom: 20px;
        }
        .compass-part {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; object-fit: contain;
        }

        #poem-display {
            min-height: 100px; display: flex; align-items: center; justify-content: center;
            text-align: center; font-size: 18px; color: var(--secondary-brown);
            line-height: 1.8; padding: 0 20px; white-space: pre-wrap;
            margin-bottom: 30px;
        }

        /* æŒ‰éˆ•å€ */
        .btn-group { display: flex; gap: 15px; margin-bottom: 20px;}
        button {
            background-color: var(--btn-color); color: white; border: none;
            padding: 12px 24px; border-radius: 30px; font-size: 16px;
            font-family: 'Noto Serif TC', serif; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        button:active { transform: scale(0.95); }

        .history-btn {
            background: none; color: var(--secondary-brown); 
            font-size: 24px; opacity: 0.6; box-shadow: none;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="bg-overlay"></div>
    <div class="container">
        <div class="header">
            <h1 id="app-title">æ€å¿µæŒ‡å—</h1>
            <div id="date-weather" class="info-text">è¼‰å…¥ä¸­...</div>
        </div>

        <div class="main-cluster">
            <div class="compass-box">
                <img src="compass_dial.png" class="compass-part" id="dial" alt="éŒ¶ç›¤">
                <img src="compass_needle.png" class="compass-part" id="needle" alt="æŒ‡é‡">
            </div>
            
            <div id="poem-display">æ­£åœ¨åŒæ­¥æ€å¿µ...</div>
            
            <div class="btn-group">
                <button id="refresh-btn">è½‰å‹•å¿ƒæƒ…</button>
                <button id="save-btn">æ”¶è—æ­¤å¥</button>
            </div>
        </div>
        
        <button class="history-btn" onclick="alert('æ”¶è—åŠŸèƒ½å·²å•Ÿç”¨')">ğŸ“œ</button>
    </div>

    <script>
        // âš ï¸ è«‹åœ¨é€™è£¡å¡«å…¥ä½ çš„ Google Sheet CSV ç¶²å€
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTFH83Pu0Q5UdKN1BxoAAhuKzLLbqMy8jmfTlGQM3-xR00Xk7fXCANmkfGS4zpYrLCCGCwtIX-UQ7Ks/pub?output=csv"; 
        
        let poemList = [];

        function updateDate() {
            const now = new Date();
            const dateStr = `${now.getFullYear()}å¹´ ${String(now.getMonth() + 1).padStart(2, '0')}æœˆ ${String(now.getDate()).padStart(2, '0')}æ—¥`;
            document.getElementById('date-weather').innerHTML = `${dateStr}<br>è®€å–å¤©æ°£ä¸­...`;
            return dateStr;
        }

        async function fetchWeather(dateStr) {
            try {
                const res = await fetch("https://api.open-meteo.com/v1/forecast?latitude=25.03&longitude=121.56&current_weather=true");
                const json = await res.json();
                const temp = Math.round(json.current_weather.temperature);
                const code = json.current_weather.weathercode;
                const cond = code === 0 ? "æ™´" : (code < 4 ? "é™°" : "é›¨");
                document.getElementById('date-weather').innerHTML = `${dateStr}<br>${cond} ${temp}Â°C`;
            } catch (e) { document.getElementById('date-weather').innerHTML = `${dateStr}<br>å°åŒ— å¤©æ°£æœªçŸ¥`; }
        }

        async function init() {
            const dateStr = updateDate(); fetchWeather(dateStr);
            try {
                const res = await fetch(SHEET_URL);
                const text = await res.text();
                // è™•ç† CSV è§£æï¼Œå»é™¤å¼•è™Ÿ
                const lines = text.split('\n').map(l => l.trim().replace(/^"|"$/g, ''));
                
                if (lines.length >= 4) {
                    document.getElementById('app-title').innerText = lines[0];
                    document.getElementById('refresh-btn').innerText = lines[1];
                    document.getElementById('save-btn').innerText = lines[2];
                    // è©©å¥è™•ç†ï¼šå°‡ CSV è£¡çš„ç©ºæ ¼è½‰æ›ç‚ºæ›è¡Œ
                    poemList = lines.slice(3).map(p => p.replace(/ /g, '\n'));
                    showNewPoem(false);
                }
            } catch (e) { 
                console.error(e);
                document.getElementById('poem-display').innerText = "æš«æ™‚å¤±å»è¯ç¹«ï¼Œè«‹ç¢ºèª CSV ç¶²å€ã€‚"; 
            }
        }

        function showNewPoem(animate = true) {
            if (poemList.length === 0) return;
            const needle = document.getElementById('needle');
            
            if (animate) {
                // é‡ç½®æŒ‡é‡
                needle.style.transition = "none";
                needle.style.transform = "rotate(0deg)";
                
                // å¼·åˆ¶ç€è¦½å™¨é‡ç¹ª (Reflow) ä»¥è§¸ç™¼æ–°å‹•ç•«
                void needle.offsetWidth;

                // é–‹å§‹æ—‹è½‰
                needle.style.transition = "transform 1s cubic-bezier(0.45, 0.05, 0.55, 0.95)";
                needle.style.transform = "rotate(720deg)";
                
                setTimeout(() => {
                    const randomPoem = poemList[Math.floor(Math.random() * poemList.length)];
                    document.getElementById('poem-display').innerText = randomPoem;
                }, 1000);
            } else {
                document.getElementById('poem-display').innerText = poemList[Math.floor(Math.random() * poemList.length)];
            }
        }

        document.getElementById('refresh-btn').onclick = () => showNewPoem(true);
        init();
    </script>
</body>
</html>
