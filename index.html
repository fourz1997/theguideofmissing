<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ€å¿µæŒ‡å—</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-brown: #3E2723;
            --secondary-brown: #5D4037;
            --btn-color: #8D6E63;
            --bg-beige: #F5F5DC;
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: 'Noto Serif TC', serif;
            background-color: var(--bg-beige);
            overflow: hidden;
        }

        #bg-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('bg_paper.png');
            background-size: cover; opacity: 0.5; z-index: -1;
        }

        .container {
            display: flex; flex-direction: column;
            align-items: center; height: 100%; width: 100%;
            box-sizing: border-box; padding: 24px;
        }

        .header { margin-top: 60px; text-align: center; }
        h1 {
            font-size: 42px; color: var(--primary-brown); margin: 0;
            font-weight: 700; letter-spacing: 2px;
        }
        .info-text {
            font-size: 14px; color: var(--secondary-brown); opacity: 0.7;
            margin-top: 16px; line-height: 1.8;
        }

        .main-cluster {
            flex: 1; display: flex; flex-direction: column;
            justify-content: center; align-items: center; width: 100%;
            margin-top: -40px; /* ç¨å¾®å¾€ä¸Šæä¸€é»ï¼Œç¬¦åˆä½œå®¶è¦–è¦ºé‡å¿ƒ */
        }

        .compass-box { position: relative; width: 280px; height: 280px; }
        .compass-part { position: absolute; width: 100%; height: 100%; }

        #poem-display {
            height: 140px; display: flex; align-items: center; justify-content: center;
            text-align: center; font-size: 18px; color: var(--secondary-brown);
            line-height: 28px; padding: 20px; white-space: pre-wrap;
        }

        .btn-group { display: flex; gap: 12px; }
        button {
            background-color: var(--btn-color); color: white; border: none;
            padding: 12px 24px; border-radius: 4px; font-size: 16px;
            font-family: 'Noto Serif TC', serif; cursor: pointer;
        }
        button:active { opacity: 0.7; }

        .history-btn {
            margin-bottom: 60px; background: none; border: none;
            font-size: 24px; cursor: pointer; opacity: 0.5;
        }
    </style>
</head>
<body>
    <div id="bg-overlay"></div>
    <div class="container">
        <div class="header">
            <h1 id="app-title">æ€å¿µæŒ‡å—</h1>
            <div id="date-weather" class="info-text">2026å¹´ 02æœˆ 18æ—¥<br>å°åŒ— è®€å–ä¸­...</div>
        </div>

        <div class="main-cluster">
            <div class="compass-box">
                <img src="compass_dial.png" class="compass-part" id="dial">
                <img src="compass_needle.png" class="compass-part" id="needle">
            </div>
            <div id="poem-display">æ­£åœ¨åŒæ­¥æ€å¿µ...</div>
            <div class="btn-group">
                <button id="refresh-btn">è½‰å‹•å¿ƒæƒ…</button>
                <button id="save-btn">æ”¶è—æ­¤å¥</button>
            </div>
        </div>
        <button class="history-btn">ğŸ“œ</button>
    </div>

    <script>
        const SHEET_URL = "ä½ çš„_CSV_ç¶²å€"; // â¬…ï¸ è¨˜å¾—æ›æˆä½ çš„
        let poemList = [];

        function updateDate() {
            const now = new Date();
            const dateStr = `${now.getFullYear()}å¹´ ${String(now.getMonth() + 1).padStart(2, '0')}æœˆ ${String(now.getDate()).padStart(2, '0')}æ—¥`;
            document.getElementById('date-weather').innerHTML = `${dateStr}<br>è®€å–å¤©æ°£ä¸­...`;
            return dateStr;
        }

        async function fetchWeather(dateStr) {
            try {
                const res = await fetch("https://api.open-meteo.com/v1/forecast?latitude=25.03&longitude=121.56&current_weather=true");
                const json = await res.json();
                const temp = Math.round(json.current_weather.temperature);
                const code = json.current_weather.weathercode;
                const cond = code === 0 ? "æ™´" : (code < 4 ? "é™°" : "é›¨");
                document.getElementById('date-weather').innerHTML = `${dateStr}<br>${cond} ${temp}Â°C`;
            } catch (e) { document.getElementById('date-weather').innerHTML = `${dateStr}<br>å°åŒ— å¤©æ°£æœªçŸ¥`; }
        }

        async function init() {
            const dateStr = updateDate(); fetchWeather(dateStr);
            try {
                const res = await fetch(SHEET_URL);
                const text = await res.text();
                const lines = text.split('\n').map(l => l.trim().replace(/"/g, ''));
                if (lines.length >= 4) {
                    document.getElementById('app-title').innerText = lines[0];
                    document.getElementById('refresh-btn').innerText = lines[1];
                    document.getElementById('save-btn').innerText = lines[2];
                    poemList = lines.slice(3).map(p => p.replace(/ /g, '\n'));
                    showNewPoem(false);
                }
            } catch (e) { document.getElementById('poem-display').innerText = "æš«æ™‚å¤±å»è¯ç¹«ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚"; }
        }

        function showNewPoem(animate = true) {
            if (poemList.length === 0) return;
            const needle = document.getElementById('needle');
            if (animate) {
                needle.style.transition = "transform 1s cubic-bezier(0.45, 0.05, 0.55, 0.95)";
                needle.style.transform = "rotate(720deg)";
                setTimeout(() => {
                    needle.style.transition = "none";
                    needle.style.transform = "rotate(0deg)";
                    document.getElementById('poem-display').innerText = poemList[Math.floor(Math.random() * poemList.length)];
                }, 1000);
            } else {
                document.getElementById('poem-display').innerText = poemList[Math.floor(Math.random() * poemList.length)];
            }
        }

        document.getElementById('refresh-btn').onclick = () => showNewPoem(true);
        init();
    </script>
</body>
</html>
