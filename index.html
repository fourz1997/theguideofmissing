<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ€å¿µæŒ‡å—</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-brown: #3E2723;
            --secondary-brown: #5D4037;
            --btn-color: #8D6E63;
            --bg-beige: #F5F5DC;
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: 'Noto Serif TC', serif;
            background-color: var(--bg-beige);
            overscroll-behavior: none; /* ç¦æ­¢ä¸‹æ‹‰é‡æ•´ */
        }

        #bg-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('bg_paper.png');
            background-size: cover; opacity: 0.5; z-index: -1;
        }

        .container {
            display: flex; flex-direction: column;
            align-items: center; justify-content: space-between;
            height: 100vh; width: 100%;
            box-sizing: border-box; padding: 24px;
        }

        .header { margin-top: 40px; text-align: center; }
        h1 { font-size: 36px; color: var(--primary-brown); margin: 0; font-weight: 700; letter-spacing: 2px; }
        .info-text { font-size: 14px; color: var(--secondary-brown); opacity: 0.7; margin-top: 10px; line-height: 1.6; }

        .main-cluster { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; flex: 1; }
        .compass-box { position: relative; width: 260px; height: 260px; margin-bottom: 20px; }
        .compass-part { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; }

        #poem-display {
            min-height: 100px; display: flex; align-items: center; justify-content: center;
            text-align: center; font-size: 18px; color: var(--secondary-brown);
            line-height: 1.8; padding: 0 20px; white-space: pre-wrap; margin-bottom: 30px;
        }

        .btn-group { display: flex; gap: 15px; margin-bottom: 20px; }
        button {
            background-color: var(--btn-color); color: white; border: none;
            padding: 12px 24px; border-radius: 30px; font-size: 16px;
            font-family: 'Noto Serif TC', serif; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        button:active { transform: scale(0.95); }

        .history-btn {
            background: none; color: var(--secondary-brown); font-size: 28px; 
            opacity: 0.6; box-shadow: none; margin-bottom: 20px;
        }

        /* æ”¶è—æ¸…å–®è¦–çª— (Modal) */
        #history-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(62, 39, 35, 0.98); z-index: 100;
            flex-direction: column; padding: 40px 20px; box-sizing: border-box;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; margin-bottom: 20px; border-bottom: 1px solid rgba(245, 245, 220, 0.2); padding-bottom: 10px;
        }
        .modal-title { color: #F5F5DC; font-size: 24px; }
        .close-btn { background: none; color: #F5F5DC; font-size: 30px; padding: 0; box-shadow: none; }
        
        #history-list {
            flex: 1; overflow-y: auto; width: 100%;
        }
        .history-item {
            color: #F5F5DC; font-size: 16px; padding: 20px 0;
            border-bottom: 1px solid rgba(245, 245, 220, 0.1);
            text-align: center; line-height: 1.6; white-space: pre-wrap;
        }
        .empty-msg { color: rgba(245, 245, 220, 0.5); text-align: center; margin-top: 50px; }
    </style>
</head>
<body>
    <div id="bg-overlay"></div>
    <div class="container">
        <div class="header">
            <h1 id="app-title">æ€å¿µæŒ‡å—</h1>
            <div id="date-weather" class="info-text">è¼‰å…¥ä¸­...</div>
        </div>

        <div class="main-cluster">
            <div class="compass-box">
                <img src="compass_dial.png" class="compass-part" id="dial" alt="éŒ¶ç›¤">
                <img src="compass_needle.png" class="compass-part" id="needle" alt="æŒ‡é‡">
            </div>
            <div id="poem-display">æ­£åœ¨åŒæ­¥æ€å¿µ...</div>
            <div class="btn-group">
                <button id="refresh-btn">è½‰å‹•å¿ƒæƒ…</button>
                <button id="save-btn">æ”¶è—æ­¤å¥</button>
            </div>
        </div>
        
        <button class="history-btn" id="open-history-btn">ğŸ“œ</button>
    </div>

    <div id="history-modal">
        <div class="modal-header">
            <span class="modal-title">æ”¶è—å†Š</span>
            <button class="close-btn" id="close-history-btn">Ã—</button>
        </div>
        <div id="history-list"></div>
    </div>

    <script>
        // âš ï¸ è«‹å¡«å…¥ä½ çš„ CSV ç¶²å€
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTFH83Pu0Q5UdKN1BxoAAhuKzLLbqMy8jmfTlGQM3-xR00Xk7fXCANmkfGS4zpYrLCCGCwtIX-UQ7Ks/pub?output=csv"; 
        
        let poemList = [];
        let currentPoem = "";

        // æ—¥æœŸèˆ‡å¤©æ°£
        function updateDate() {
            const now = new Date();
            const dateStr = `${now.getFullYear()}å¹´ ${String(now.getMonth() + 1).padStart(2, '0')}æœˆ ${String(now.getDate()).padStart(2, '0')}æ—¥`;
            document.getElementById('date-weather').innerHTML = `${dateStr}<br>è®€å–å¤©æ°£ä¸­...`;
            return dateStr;
        }

        async function fetchWeather(dateStr) {
            try {
                const res = await fetch("https://api.open-meteo.com/v1/forecast?latitude=25.03&longitude=121.56&current_weather=true");
                const json = await res.json();
                const temp = Math.round(json.current_weather.temperature);
                const code = json.current_weather.weathercode;
                const cond = code === 0 ? "æ™´" : (code < 4 ? "é™°" : "é›¨");
                document.getElementById('date-weather').innerHTML = `${dateStr}<br>${cond} ${temp}Â°C`;
            } catch (e) { document.getElementById('date-weather').innerHTML = `${dateStr}<br>å°åŒ— å¤©æ°£æœªçŸ¥`; }
        }

        // åˆå§‹åŒ–
        async function init() {
            const dateStr = updateDate(); fetchWeather(dateStr);
            try {
                const res = await fetch(SHEET_URL);
                const text = await res.text();
                const lines = text.split('\n').map(l => l.trim().replace(/^"|"$/g, ''));
                if (lines.length >= 4) {
                    document.getElementById('app-title').innerText = lines[0];
                    document.getElementById('refresh-btn').innerText = lines[1];
                    document.getElementById('save-btn').innerText = lines[2];
                    poemList = lines.slice(3).map(p => p.replace(/ /g, '\n'));
                    showNewPoem(false);
                }
            } catch (e) { 
                document.getElementById('poem-display').innerText = "æš«æ™‚å¤±å»è¯ç¹«ï¼Œè«‹ç¢ºèªç¶²è·¯ã€‚"; 
            }
        }

        // é¡¯ç¤ºæ–°è©©å¥
        function showNewPoem(animate = true) {
            if (poemList.length === 0) return;
            const needle = document.getElementById('needle');
            
            if (animate) {
                needle.style.transition = "none";
                needle.style.transform = "rotate(0deg)";
                void needle.offsetWidth; // é‡ç¹ª
                needle.style.transition = "transform 1s cubic-bezier(0.45, 0.05, 0.55, 0.95)";
                needle.style.transform = "rotate(720deg)";
                
                setTimeout(() => {
                    currentPoem = poemList[Math.floor(Math.random() * poemList.length)];
                    document.getElementById('poem-display').innerText = currentPoem;
                }, 1000);
            } else {
                currentPoem = poemList[Math.floor(Math.random() * poemList.length)];
                document.getElementById('poem-display').innerText = currentPoem;
            }
        }

        // ğŸŒŸ æ”¶è—åŠŸèƒ½
        function savePoem() {
            if (!currentPoem || currentPoem.includes("åŒæ­¥")) return;
            
            // è®€å–èˆŠçš„æ”¶è—
            let favorites = JSON.parse(localStorage.getItem('my_poems') || "[]");
            
            if (!favorites.includes(currentPoem)) {
                favorites.unshift(currentPoem); // åŠ åˆ°æœ€å‰é¢
                localStorage.setItem('my_poems', JSON.stringify(favorites));
                alert("å·²æ”¶å…¥æ”¶è—å†Š");
            } else {
                alert("é€™å¥å·²ç¶“åœ¨æ”¶è—å†Šè£¡äº†");
            }
        }

        // ğŸŒŸ é¡¯ç¤ºæ”¶è—åˆ—è¡¨
        function toggleHistory(show) {
            const modal = document.getElementById('history-modal');
            const list = document.getElementById('history-list');
            
            if (show) {
                let favorites = JSON.parse(localStorage.getItem('my_poems') || "[]");
                list.innerHTML = "";
                if (favorites.length === 0) {
                    list.innerHTML = "<div class='empty-msg'>é‚„æ²’æœ‰æ”¶è—ä»»ä½•è©©å¥</div>";
                } else {
                    favorites.forEach(p => {
                        const item = document.createElement('div');
                        item.className = 'history-item';
                        item.innerText = p;
                        list.appendChild(item);
                    });
                }
                modal.style.display = 'flex';
            } else {
                modal.style.display = 'none';
            }
        }

        document.getElementById('refresh-btn').onclick = () => showNewPoem(true);
        document.getElementById('save-btn').onclick = savePoem;
        document.getElementById('open-history-btn').onclick = () => toggleHistory(true);
        document.getElementById('close-history-btn').onclick = () => toggleHistory(false);

        init();
    </script>
</body>
</html>
